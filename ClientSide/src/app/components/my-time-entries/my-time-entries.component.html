<p-toast />
<div class="table-container">
    <div>
        <h2>My Time Entries</h2>
        <div *ngIf="isAdmin" class="flex justify-center" style="margin-bottom: 10px;">
            <label>Employee:</label>
            <p-select [options]="employees"
                (onChange)="onEmployeeChange($event)"
                showClear="true"
                [(ngModel)]="currentEmployeeId"
                optionLabel="name"
                optionValue="id"
                placeholder="Select an employee"
                class="w-full md:w-56">
            </p-select>
        </div>
    </div>
    <div class="table-header">
        <div class="button-group">
            <p-button [loading]="loading" label="Previous Week" (click)="previousWeek()"></p-button>
            <p-button [loading]="loading" label="Next Week" (click)="nextWeek()"></p-button>
            <p-button *ngIf="!isCurrentWeek()" [loading]="loading" label="Current Week" (click)="getCurrentDate()" severity="info"></p-button>
            <p-button *ngIf="isAdmin" [loading]="loading" [label]="isClosed ? 'Open Week' : 'Close Week'" (click)="changeWeekStatus()" name="closeActionButton" [severity]="isClosed ? 'warn' : 'contrast'"></p-button>
        </div>
        <!-- Centered Date Range -->
        <span class="date-range">{{ dateRange }}</span>
        <p-button label="Add New Entry" icon="pi pi-plus" (click)="showNewEntryDialog()"></p-button>
    </div>
    <!-- Table to display time entries -->
    <p-table [value]="timeEntries" [loading]="loading" [paginator]="true" [rows]="rowsPerPage" [lazy]="false"
        [totalRecords]="totalRecords">

        <ng-template pTemplate="header">
            <tr>
                <th>Task Name</th>
                <th>Hours Worked</th>
                <th>Date</th>
                <th>Comments</th>
                <th class="task-table-header">Actions</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-entry>
            <tr>
                <td>
                    {{ entry.task.name }}
                    <span *ngIf="entry.task.isTimeOff" [ngClass]="{
                        'pending': entry.timeOffRequest?.status === 'Pending',
                        'rejected': entry.timeOffRequest?.status === 'Rejected',
                        'approved': entry.timeOffRequest?.status === 'Approved'
                      }">
                      ({{ entry.timeOffRequest?.status || '' }})
                    </span>
                  </td>
                <td>{{ entry.hours }}</td>
                <td>{{ entry.date | date: 'fullDate' }}</td>
                <td class="comment-cell">{{ entry.comment }}</td>
                <td>
                    <!-- Edit Button -->
                    <button pButton type="button" label="Edit" class="custom-edit-button" (click)="showEditEntryDialog(entry, entry.id)" severity="info" style="margin-right: 5px;"></button>
                    <!-- Delete Button -->
                    <button pButton type="button" label="Delete" class="custom-delete-button" (click)="confirmDeleteTimeEntry(entry.id)" severity="danger"></button>
                </td>
            </tr>
        </ng-template>
        <!-- Display empty message when there are no time entries for specified week -->
        <ng-template #emptymessage>
            <tr>
                <td class="empty-message" colspan="6">No time entries found for this week.</td>
            </tr>
        </ng-template>
    </p-table>
</div>

<!-- Dialog for handling time entries. This version should handle both add and edit depending on whether add new entry or edit for a row was selected. -->
<p-dialog [header]="dialogHeader" [(visible)]="displayDialog" [modal]="true" closable="false" resizable="true"
    [style]="{ width: '30rem', height: '40rem' }">
    <form #entryForm="ngForm">
        <div class="input-field">
            <label for="task-selector">Select a Task</label>
            <p-select id="task-selector" [(ngModel)]="timeEntryRequest.TaskId" #selector="ngModel" [options]="tasks"
                optionLabel="name" optionValue="id" [loading]="selectLoading" required name="selectedTask" ></p-select>

            <!--Conditional error message-->
            @if (submitClicked && (selector.invalid || selector.pristine)) {
            <small class="error-msg">Task is required.</small>
            }
        </div>

        <div class="input-field">
            <label for="date-picker">Date Completed</label>
            <p-datepicker id="date-picker" [(ngModel)]="timeEntryRequest.Date" #datepkr="ngModel" showIcon="true"
                [maxDate]="maxDate" name="selectedDate" required />

            <!--Conditional error message-->
            @if (submitClicked && (datepkr.invalid || datepkr.pristine)) {
            <small class="error-msg">Date is required.</small>
            }
        </div>

        <div class="input-field">
            <label for="integeronly">Hours Worked</label>
            <p-inputnumber inputId="integeronly" #hrInput="ngModel" [(ngModel)]="timeEntryRequest.Hours" [min]="1"
                name="hrsWorked" required />

            <!--Conditional error message-->
            @if (submitClicked && (hrInput.invalid || hrInput.pristine)) {
            <small class="error-msg">Hours are required.</small>
            }
        </div>

        <div class="input-field">
            <label for="comment-box">Additional Comments <em>(optional)</em></label>
            <textarea id="comment-box" rows="5" cols="30" pTextarea [(ngModel)]="timeEntryRequest.Comment"
                name="comment"></textarea>
        </div>
    </form>

    <!-- Form control buttons -->
    <div class="btns">
        <p-button [label]="submitLabel" (click)="submitTimeEntry(entryForm)"></p-button>
        <p-button severity="secondary" label="Cancel" (click)="closeDialog(entryForm)"></p-button>
    </div>
</p-dialog>

<!-- Confirmation Dialog for Deleting Time Entry -->
<p-dialog header="Confirm Deletion" [(visible)]="deleteConfirmDialog" [responsive]="true" [modal]="true">
    <p class="dialogue-content">Are you sure you want to delete this time entry?</p>
    <div class="btns p-dialog-margins">
        <button pButton label="Yes" class="confirm-delete-button" (click)="deleteTimeEntry()"></button>
        <button pButton label="No" class="cancel-delete-button" (click)="cancelDelete()" severity="secondary"></button>
    </div>
  </p-dialog>

  <!-- Confirmation dialog for closing a week -->
  <p-dialog header="Confirm Close" [(visible)]="closeConfirmDialog" [responsive]="true" [modal]="true">
    <p>Are you sure you want to close this week?</p>
    <div class="btns">
        <button pButton label="Close" (click)="closeWeek()"></button>
        <button pButton label="Cancel" (click)="cancelClose()" severity="secondary"></button>
    </div>
  </p-dialog>
